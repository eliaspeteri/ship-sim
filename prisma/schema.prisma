// This file defines the database schema using Prisma's schema definition language.
// It specifies models, fields, and relationships for the PostgreSQL database.

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Main vessel definition model
model Vessel {
    id             Int      @id @default(autoincrement())
    name           String
    type           String
    length         Float
    beam           Float // Changed from 'width' to match marine terminology
    draft          Float
    displacement   Float
    mass           Float
    maxSpeed       Float
    maxRudderAngle Float
    enginePower    Float
    fuelCapacity   Float
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt

    // Relations
    vesselStates VesselState[]
}

// Role model for access control
model Role {
    id          String   @id @default(uuid())
    name        String   @unique
    description String?
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    // Relations
    permissions RolePermission[]
    userRoles   UserRole[]
}

// Permission model defining allowed actions
model Permission {
    id          String   @id @default(uuid())
    name        String   @unique
    resource    String // The resource this permission applies to (vessels, environment, etc.)
    action      String // The action allowed (read, write, control, etc.)
    description String?
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    // Relations
    rolePermissions RolePermission[]
}

// Many-to-many relation between roles and permissions
model RolePermission {
    roleId       String
    permissionId String

    role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
    permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

    @@id([roleId, permissionId])
}

// User model
model User {
    id           String   @id @default(uuid()) // Changed to String for UUID compatibility
    username     String   @unique
    email        String   @unique
    passwordHash String
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    // Relations
    roles        UserRole[]
    settings     UserSettings?
    vesselStates VesselState[]
}

// Many-to-many relation between users and roles
model UserRole {
    userId String
    roleId String

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

    @@id([userId, roleId])
}

// Vessel state for simulation persistence
model VesselState {
    id       Int    @id @default(autoincrement())
    userId   String @unique // Unique constraint to ensure one state per user
    vesselId Int? // Optional relation to a specific vessel type

    // Position
    positionX Float
    positionY Float
    positionZ Float

    // Orientation
    heading Float // Psi - yaw
    roll    Float // Phi
    pitch   Float // Theta

    // Velocity
    velocityX Float // Surge
    velocityY Float // Sway
    velocityZ Float // Heave

    // Angular velocity components (not currently used)
    yawRate   Float? // r
    rollRate  Float? // p
    pitchRate Float? // q

    // Control state
    throttle    Float @default(0)
    rudderAngle Float @default(0)

    // Ship properties (can be overridden from vessel defaults)
    mass   Float?
    length Float?
    beam   Float?
    draft  Float?

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    vessel Vessel? @relation(fields: [vesselId], references: [id])
    user   User    @relation(fields: [userId], references: [id])
}

// Environment state
model EnvironmentState {
    id Int @id @default(autoincrement())

    // Wind
    windSpeed     Float
    windDirection Float

    // Current
    currentSpeed     Float
    currentDirection Float

    // Sea state (Beaufort scale 0-12)
    seaState Int

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// User settings
model UserSettings {
    id     Int    @id @default(autoincrement())
    userId String @unique

    // UI preferences
    cameraMode   String  @default("thirdPerson") // thirdPerson, firstPerson, topDown, etc.
    soundEnabled Boolean @default(true)
    showHUD      Boolean @default(true)

    // Simulation preferences
    timeScale Float @default(1.0)

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    user User @relation(fields: [userId], references: [id])
}

// Saved simulation scenarios
model Scenario {
    id          Int     @id @default(autoincrement())
    name        String
    description String?

    // Initial states
    initialVesselState Json
    initialEnvironment Json

    // Scenario-specific settings
    duration   Int? // Duration in seconds, if applicable
    objectives Json? // Array of objectives

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}
